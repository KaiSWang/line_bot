<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥­å‹™å°ˆç”¨å¾Œå°</title>
    <style>
        /* ç°¡å–®çš„ CSSï¼Œä¹‹å¾Œå†å„ªåŒ– */
        body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chat-box { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #fff; }
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 15px; max-width: 80%; width: fit-content; }
        .incoming { background: #f1f0f0; float: left; clear: both; } /* å®¢æˆ¶ */
        .outgoing { background: #dcf8c6; float: right; clear: both; } /* æ¥­å‹™ */
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #00B900; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’¬ 1å°1 èŠå¤©å®¤</h2>
    
    <div style="margin-bottom: 15px;">
        <label>æˆ‘æ˜¯æ¥­å‹™:</label>
        <input type="text" id="myAgentId" value="agent01" style="width: 100px;">
    </div>

    <div class="chat-box" id="chatWindow">
        <div style="text-align: center; color: #999;">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="input-area">
        <input type="text" id="msgInput" placeholder="è¼¸å…¥å›è¦†...">
        <button onclick="sendMsg()">å‚³é€</button>
    </div>
    
    <button onclick="loadHistory()" style="margin-top: 10px; background: #666;">åˆ·æ–°è¨Šæ¯</button>
</div>

<script>
    // ğŸ”¥ é‡è¦ï¼šè«‹å¡«å…¥æ‚¨çš„ GAS éƒ¨ç½²ç¶²å€ (çµå°¾æ˜¯ /exec)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyzC2W0P3tclP8OptxAr0Mb2kMVAdvl4y_moqvZeagL0InLb8TfqQVWRifFjie3Az0GvA/exec";

    // 1. æ’ˆå–æ­·å²ç´€éŒ„
    function loadHistory() {
        const agentId = document.getElementById('myAgentId').value;

        fetch(GAS_URL, {
            method: "POST", // GAS doPost åªåƒ POST
            body: JSON.stringify({ 
                action: 'get_chat_history', // å‘Šè¨´å¾Œç«¯æˆ‘è¦åšä»€éº¼
                agentId: agentId 
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                renderChat(data.data);
            } else {
                alert('éŒ¯èª¤: ' + data.msg);
            }
        })
        .catch(err => console.error(err));
    }

    // 2. æ¸²æŸ“ç•«é¢
    function renderChat(logs) {
        const box = document.getElementById('chatWindow');
        box.innerHTML = ''; // æ¸…ç©º
        logs.forEach(log => {
            const div = document.createElement('div');
            // åˆ¤æ–·æ˜¯èª°å‚³çš„ (å‡è¨­ 'Agent->User' æ˜¯æˆ‘ç™¼çš„)
            const isMe = log.direction === 'Agent->User';
            div.className = 'msg ' + (isMe ? 'outgoing' : 'incoming');
            div.innerText = (isMe ? '' : 'å®¢: ') + log.msg;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight; // æ²åˆ°åº•éƒ¨
    }

    // 3. ç™¼é€è¨Šæ¯
    function sendMsg() {
        const msg = document.getElementById('msgInput').value;
        const agentId = document.getElementById('myAgentId').value;
        if(!msg) return;

        // UI å…ˆé¡¯ç¤º (å„ªåŒ–é«”é©—)
        const box = document.getElementById('chatWindow');
        const div = document.createElement('div');
        div.className = 'msg outgoing';
        div.innerText = msg;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        document.getElementById('msgInput').value = '';

        // å‘¼å«å¾Œç«¯
        fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify({
                action: 'send_message',
                agentId: agentId,
                userId: 'U123456...', // æš«æ™‚å¯«æ­»ï¼Œä¹‹å¾Œè¦å¾é¸å–®é¸å®¢æˆ¶
                message: msg
            })
        });
    }

    // ä¸€é€²ä¾†å…ˆæ’ˆä¸€æ¬¡
    // loadHistory(); 
</script>

</body>
</html>